<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

.chart rect {
  fill: gray;
}

.chart rect.males{
  fill: lightblue;
}


.chart rect.females{
  fill: steelblue;/*white;*/
}

.chart text {
  fill: black;
  font: 10px sans-serif;
  text-anchor: end;
}

.chart text.females {
  text-anchor: start;
}

section {
    width:48%;
    float:left;
}

</style>
</head>
<body>
<h1>Population Histograms</h1>
<div>
    <label for="year1">Year 1</label> <input type="number" id="year1" value="1960" min="1950" max="2023"/> 
    <label for="year2">Year 2</label> <input type="number" id="year2" value="2010" min="1950" max="2023" /> 
	<br>
	<label for="country1">Country 1</label> <select id="country1"></select><br
	<label for="country2">Country 2</label> <select id="country2"></select><br>
	<br
	<label for="groupLen">Group into</label> <input type="number" id="groupLen" value="10"  min="5" max="10" step="5" length="3"/> year bands
    <button onClick="draw()">Draw</button>
</div>

<section>
    <h2 id="label-0-0">Brazil 1980 - Millions</h2>
    <svg class="chart" id="chart-0-0"></svg>
</section>

<section>
    <h2 id="label-0-1" >Brazil 2000 - Millions</h2>
    <svg class="chart" id="chart-0-1"></svg>
</section>

<section>
    <h2 id="label-1-0">China 1980 - Millions</h2>
    <svg class="chart" id="chart-1-0"></svg>
</section>

<section>
    <h2 id="label-1-1">China 2000 - Millions</h2>
    <svg class="chart" id="chart-1-1"></svg>
</section>


<section>
<p> The charts are made in the page by using <a href="http://d3js.org" target="_blank" >D3.js</a> (<a href="http://bost.ocks.org/mike/bar/3/">example</a>) </p>
<p> The data now comes from the <a href="https://datahelpdesk.worldbank.org/knowledgebase/articles/889392-about-the-indicators-api-documentation"  target="_blank" >World Bank Indicators API</a> (population by age and sex, 5-year bands).</p>
</section>



<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>


<script>
// Age-band indicators for World Bank population by age and sex (5-year buckets, 80+ open-ended)
var indicatorBands = [
	{ start: 0, label: "0-4", male: "SP.POP.0004.MA", female: "SP.POP.0004.FE" },
	{ start: 5, label: "5-9", male: "SP.POP.0509.MA", female: "SP.POP.0509.FE" },
	{ start: 10, label: "10-14", male: "SP.POP.1014.MA", female: "SP.POP.1014.FE" },
	{ start: 15, label: "15-19", male: "SP.POP.1519.MA", female: "SP.POP.1519.FE" },
	{ start: 20, label: "20-24", male: "SP.POP.2024.MA", female: "SP.POP.2024.FE" },
	{ start: 25, label: "25-29", male: "SP.POP.2529.MA", female: "SP.POP.2529.FE" },
	{ start: 30, label: "30-34", male: "SP.POP.3034.MA", female: "SP.POP.3034.FE" },
	{ start: 35, label: "35-39", male: "SP.POP.3539.MA", female: "SP.POP.3539.FE" },
	{ start: 40, label: "40-44", male: "SP.POP.4044.MA", female: "SP.POP.4044.FE" },
	{ start: 45, label: "45-49", male: "SP.POP.4549.MA", female: "SP.POP.4549.FE" },
	{ start: 50, label: "50-54", male: "SP.POP.5054.MA", female: "SP.POP.5054.FE" },
	{ start: 55, label: "55-59", male: "SP.POP.5559.MA", female: "SP.POP.5559.FE" },
	{ start: 60, label: "60-64", male: "SP.POP.6064.MA", female: "SP.POP.6064.FE" },
	{ start: 65, label: "65-69", male: "SP.POP.6569.MA", female: "SP.POP.6569.FE" },
	{ start: 70, label: "70-74", male: "SP.POP.7074.MA", female: "SP.POP.7074.FE" },
	{ start: 75, label: "75-79", male: "SP.POP.7579.MA", female: "SP.POP.7579.FE" },
	{ start: 80, label: "80+", male: "SP.POP.80UP.MA", female: "SP.POP.80UP.FE", openEnded: true }
];

var groupLength = 10;
var countryCodeCache = {};
var countryListPromise = null;
var countryOptions = [];
var latestYear = 2023;

var proccessYear = function(json) {
	var data = [];
	json.forEach(function(year){
			var group = Math.floor(year.age / groupLength);
			if(!data[group]) {
				data[group] = {
					total: 0,
					males: 0,
					females: 0,
					label: ""+(group * groupLength)+"-"+(((group+1) * groupLength)-1)
				};
			}
			data[group].total += year.total;
			data[group].males += year.males;
			data[group].females += year.females;
			if (year.openEnded) {
				data[group].label = year.label || data[group].label;
			}
		});
	return data.filter(Boolean);
};

function visualizeit(sSelector, data) {
		var width = 450,
				barHeight = 20,
				leftMargin = 50;
    
		var male_x = d3.scale.linear()
				.range([leftMargin + ((width-leftMargin) / 2) , width]);
        
		var female_x = d3.scale.linear()
				.range([leftMargin + ((width-leftMargin) / 2) , leftMargin]);
    
		var width_x = d3.scale.linear()
				.range([0, ((width-leftMargin) / 2)]);
    
		var chart = d3.select(sSelector)
				.attr("width", width);
        
		male_x.domain([0, d3.max(data, function(d) { return Math.max(d.males, d.females); })]);
		female_x.domain([0, d3.max(data, function(d) { return Math.max(d.males, d.females); })]);
		width_x.domain([0, d3.max(data, function(d) { return Math.max(d.males, d.females); })]);
    
		chart.attr("height", barHeight * data.length);
  
		var bar = chart.selectAll("g")
				.data(data)
			.enter().append("g")
				.attr("transform", function(d, i) { return "translate(0," + (data.length - 1 - i ) * barHeight + ")"; });
  
		bar.append("rect")
				.attr("x",  male_x(0))
				.attr("width", function(d) { return width_x(d.males); })
				.attr("title", function(d) { return "Males aged "+d.label+" = "+ d.males; })
				.attr("height", barHeight - 1)
				.attr("class", "males");
  
		bar.append("rect")
				.attr("x", function(d) { return female_x( d.females); })
				.attr("width", function(d) { return width_x( d.females); })
				.attr("title", function(d) { return "Females aged "+d.label+" = "+ d.females; })
				.attr("height", barHeight - 1 )
				.attr("class", "females");
        
		bar.append("text")
				.attr("x", function(d) { 
							if (width_x(d.males) > 30 ) {
									return male_x(d.males) - 3 ;
							} else {
									return male_x(0) + 50;
							}
				})
				.attr("y", barHeight / 2)
				.attr("dy", ".35em")
				.attr("class", "males")
				.text(function(d) { return Math.round(d.males/100000)/10; });
        
		bar.append("text")
				.attr("x", function(d) { 
							if (width_x(d.females) > 30 ) {
									return female_x(d.females) + 3 ;
							} else {
									return female_x(0) - 50;
							}
					})
				.attr("y", barHeight / 2)
				.attr("dy", ".35em")
				.attr("class", "females")
				.text(function(d) { return Math.round(d.females/100000)/10; });
        
		bar.append("text")
				.attr("x", leftMargin)
				.attr("y", barHeight / 2)
				.attr("dy", ".35em")
				.attr("class", "labels")
				.text(function(d) { return d.label  });
}

function populateCountrySelects() {
	var select1 = document.getElementById("country1");
	var select2 = document.getElementById("country2");
	if (!select1 || !select2) return;
	
	[select1, select2].forEach(function(select) {
		select.innerHTML = "";
		countryOptions.forEach(function(c) {
			var opt = document.createElement("option");
			opt.value = c.code; // ISO-2 required by API
			opt.textContent = c.name;
			select.appendChild(opt);
		});
	});
	
	// Set default values
	select1.value = "BR";
	select2.value = "CN";
}

function fetchLatestYear() {
	return fetch("https://api.worldbank.org/v2/country/US/indicator/SP.POP.TOTL?format=json&per_page=1")
		.then(function(resp) { return resp.json(); })
		.then(function(json) {
			if (Array.isArray(json) && Array.isArray(json[1]) && json[1][0] && json[1][0].date) {
				latestYear = parseInt(json[1][0].date, 10);
				document.getElementById("year1").setAttribute("max", latestYear);
				document.getElementById("year2").setAttribute("max", latestYear);
			}
			return latestYear;
		})
		.catch(function() {
			return latestYear; // fallback to default
		});
}

function loadCountryCodes() {
	if (countryListPromise) {
		return countryListPromise;
	}
	countryListPromise = fetch("https://api.worldbank.org/v2/country?format=json&per_page=400")
		.then(function(resp) { return resp.json(); })
		.then(function(json) {
			if (Array.isArray(json) && Array.isArray(json[1])) {
				json[1].forEach(function(c) {
					if (c && c.name && (c.iso2Code || c.id)) {
						var code = (c.iso2Code || c.id).toUpperCase();
						var nameKey = c.name.toLowerCase();
						var codeKey = code.toLowerCase();
						countryCodeCache[nameKey] = code; // name -> iso2
						countryCodeCache[codeKey] = code; // iso2 -> iso2
						countryOptions.push({ code: code, name: c.name });
					}
				});
				countryOptions.sort(function(a, b) { return a.name.localeCompare(b.name); });
				populateCountrySelects();
			}
			return countryCodeCache;
		});
	return countryListPromise;
}

function getCountryCode(countryName) {
	var key = countryName.trim().toLowerCase();
	if (countryCodeCache[key]) {
		return Promise.resolve(countryCodeCache[key]);
	}
	return loadCountryCodes().then(function() {
		return countryCodeCache[key] || null;
	});
}

function closestValueFromSeries(series, targetYear) {
	var best = null;
	series.forEach(function(item) {
		if (!item || item.value === null) return;
		var yearNum = parseInt(item.date, 10);
		var dist = Math.abs(yearNum - targetYear);
		if (best === null || dist < best.dist) {
			best = { dist: dist, value: +item.value };
		}
	});
	return best ? best.value : 0;
}

function fetchIndicatorValue(countryCode, indicator, year) {
	var primaryUrl = "https://api.worldbank.org/v2/country/"+countryCode+"/indicator/"+indicator+"?date="+year+":"+year+"&format=json&per_page=5";
	var fallbackUrl = "https://api.worldbank.org/v2/country/"+countryCode+"/indicator/"+indicator+"?date="+(year-5)+":"+(year+5)+"&format=json&per_page=50";

	function parseResponse(json) {
		if (Array.isArray(json) && json[0] && json[0].message) {
			var msg = Array.isArray(json[0].message) && json[0].message[0] ? json[0].message[0].value : "World Bank API error";
			throw new Error(msg);
		}
		if (Array.isArray(json) && Array.isArray(json[1])) {
			var exact = json[1].find(function(item) { return item && item.date === String(year) && item.value !== null; });
			if (exact && exact.value !== null) {
				return +exact.value;
			}
			return closestValueFromSeries(json[1], year);
		}
		return 0;
	}

	return fetch(primaryUrl)
		.then(function(resp) { return resp.json(); })
		.then(function(json) {
			var val = parseResponse(json);
			if (val !== 0) return val;
			// fallback wider window
			return fetch(fallbackUrl)
				.then(function(resp) { return resp.json(); })
				.then(parseResponse);
		});
}

function fetchWorldBankAgeBands(countryName, year) {
	return getCountryCode(countryName).then(function(code) {
		if (!code) {
			throw new Error("Country not found in World Bank API: " + countryName);
		}
		return Promise.all(indicatorBands.map(function(band) {
			return Promise.all([
				fetchIndicatorValue(code, band.male, year),
				fetchIndicatorValue(code, band.female, year)
			]).then(function(values) {
				return {
					age: band.start,
					label: band.label,
					males: values[0],
					females: values[1],
					total: values[0] + values[1],
					openEnded: band.openEnded || false
				};
			});
		}));
	});
}

function getCountryName(countryCode) {
	var option = countryOptions.find(function(c) { return c.code === countryCode; });
	return option ? option.name : countryCode;
}

function draw() {
		groupLength = Math.max(5, parseInt(document.getElementById("groupLen").value, 10) || 10); // WB data is 5-year bands
		var aYears = [document.getElementById("year1").value, document.getElementById("year2").value];
		var aCountries = [document.getElementById("country1").value, document.getElementById("country2").value];

		aCountries.forEach(function(country, i) {
				aYears.forEach(function(year, j) {
						var countryName = getCountryName(country);
						var sLabel = countryName+" "+ year;
						var sLabelID = "label-"+i+"-"+j;
						var ele = document.getElementById(sLabelID);
						ele.innerHTML = sLabel;
						var chartId = "chart-"+i+"-"+j;
						document.getElementById(chartId).innerHTML = "";

						fetchWorldBankAgeBands(country, year)
							.then(function(rawData) {
								var grouped = proccessYear(rawData);
								visualizeit("#"+chartId, grouped);
							})
							.catch(function(err) {
								console.error(err);
								d3.select("#"+chartId).append("text")
									.text("No data")
									.attr("x", 10)
									.attr("y", 20);
							});
				});
		});
}

fetchLatestYear().then(function() {
	return loadCountryCodes();
}).then(draw);

</script>


</body>
</html>

